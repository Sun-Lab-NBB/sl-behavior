# Log File Architecture Reference

Comprehensive documentation of `.npz` log archives generated during Sun Lab VR data acquisition sessions. Use this
reference when answering questions about log composition, debugging processing errors, or understanding data structures.

---

## Log File Overview

This library processes `.npz` log archives with unique numeric source IDs identifying their origin.

### Source ID Assignments

| Source ID | Log File       | Generator Library                   | Content                              |
|-----------|----------------|-------------------------------------|--------------------------------------|
| 1         | `1_log.npz`    | sl-experiment (Mesoscope-VR)        | VR system state, runtime, trials     |
| 51        | `51_log.npz`   | ataraxis-video-system               | Face camera frame timestamps         |
| 62        | `62_log.npz`   | ataraxis-video-system               | Body camera frame timestamps         |
| 101       | `101_log.npz`  | ataraxis-communication-interface    | Actor microcontroller modules        |
| 152       | `152_log.npz`  | ataraxis-communication-interface    | Sensor microcontroller modules       |
| 203       | `203_log.npz`  | ataraxis-communication-interface    | Encoder microcontroller modules      |

### Common Message Envelope

All log files share a common message envelope format:

| Offset   | Size     | Type   | Description                                             |
|----------|----------|--------|---------------------------------------------------------|
| 0        | 1 byte   | uint8  | Source ID - identifies the logging component            |
| 1-8      | 8 bytes  | uint64 | Timestamp - microseconds elapsed since onset (or 0)     |
| 9+       | Variable | varies | Payload - source-specific data                          |

### Onset Timestamp Handling

Each log file contains a special onset message where `timestamp = 0`. The payload of this message contains the absolute
UTC timestamp in microseconds since Unix epoch. All other timestamps are relative to this onset, enabling reconstruction
of absolute timestamps via `absolute_time = onset_us + elapsed_us`.

---

## Runtime Data Log (1_log.npz)

The runtime log captures VR system state, session runtime state, trial guidance, and cue sequences. Generated by the
`_MesoscopeVRSystem` class in sl-experiment.

### Message Codes

| Code | Name                      | Payload Size | Description                                    |
|------|---------------------------|--------------|------------------------------------------------|
| 1    | SYSTEM_STATE              | 2 bytes      | VR system configuration state change           |
| 2    | RUNTIME_STATE             | 2 bytes      | Session runtime stage change                   |
| 3    | REINFORCING_GUIDANCE      | 2 bytes      | Water reward trial guidance mode change        |
| 4    | AVERSIVE_GUIDANCE         | 2 bytes      | Gas puff trial guidance mode change            |
| 5    | DISTANCE_SNAPSHOT         | 9 bytes      | Cumulative distance at cue sequence change     |
| >500 | CUE_SEQUENCE              | Variable     | VR wall cue sequence (uint8 array)             |

### VR System States

| Code | State         | Description                                                |
|------|---------------|------------------------------------------------------------|
| 0    | IDLE          | System paused or not conducting acquisition                |
| 1    | REST          | Rest period: brake engaged, screens off, torque enabled    |
| 2    | RUN           | Run period: brake disengaged, encoder enabled              |
| 3    | LICK_TRAINING | Lick training: wheel locked, animal trains to lick         |
| 4    | RUN_TRAINING  | Run training: wheel unlocked, animal trains to run         |

### Trial Decomposition

Cue sequences are decomposed into individual trials using a greedy longest-match algorithm. Each trial type has a unique
wall cue motif (byte sequence) defined in the experiment configuration. The algorithm:

1. Iterates through the cue sequence from the start
2. Matches the longest possible trial motif at each position
3. Records the trial type index and cumulative distance threshold
4. Continues until the entire sequence is decomposed

### Output Files

| Output File                               | Columns                                        |
|-------------------------------------------|------------------------------------------------|
| `system_state_data.feather`               | `time_us`, `system_state`                      |
| `runtime_state_data.feather`              | `time_us`, `runtime_state`                     |
| `reinforcing_guidance_state_data.feather` | `time_us`, `reinforcing_guidance_state`        |
| `aversive_guidance_state_data.feather`    | `time_us`, `aversive_guidance_state`           |
| `vr_cue_data.feather`                     | `vr_cue`, `traveled_distance_cm`               |
| `vr_trigger_zone_data.feather`            | `trigger_zone_start_cm`, `trigger_zone_end_cm` |
| `trial_data.feather`                      | `trial_type_index`, `traveled_distance_cm`     |

---

## Camera Data Logs (51_log.npz, 62_log.npz)

Camera logs contain frame acquisition timestamps generated by ataraxis-video-system's `VideoSystem` class.

### Message Format

**Regular Frame Message (9 bytes total):**

| Offset  | Size    | Type   | Description                           |
|---------|---------|--------|---------------------------------------|
| 0       | 1 byte  | uint8  | Source ID (51 or 62)                  |
| 1-8     | 8 bytes | uint64 | Microseconds elapsed since onset      |

**Onset Message (17 bytes total):**

| Offset  | Size    | Type   | Description                           |
|---------|---------|--------|---------------------------------------|
| 0       | 1 byte  | uint8  | Source ID                             |
| 1-8     | 8 bytes | uint64 | Zero (indicates onset message)        |
| 9-16    | 8 bytes | int64  | Absolute UTC timestamp (microseconds) |

### Output Files

| Input Log      | Output File                         | Columns         |
|----------------|-------------------------------------|-----------------|
| `51_log.npz`   | `face_camera_timestamps.feather`    | `frame_time_us` |
| `62_log.npz`   | `body_camera_timestamps.feather`    | `frame_time_us` |

---

## Microcontroller Data Logs

Microcontroller logs contain hardware module event data generated by ataraxis-communication-interface. Each
microcontroller manages multiple hardware modules identified by (module_type, module_id) pairs.

### Message Format

| Offset  | Size     | Type   | Description                                    |
|---------|----------|--------|------------------------------------------------|
| 0       | 1 byte   | uint8  | Source ID (101, 152, or 203)                   |
| 1-8     | 8 bytes  | uint64 | Microseconds elapsed since onset               |
| 9       | 1 byte   | uint8  | Protocol code (6=MODULE_DATA, 8=MODULE_STATE)  |
| 10      | 1 byte   | uint8  | Module type                                    |
| 11      | 1 byte   | uint8  | Module instance ID                             |
| 12      | 1 byte   | uint8  | Command code                                   |
| 13      | 1 byte   | uint8  | Event code (51+ for custom data)               |
| 14      | 1 byte   | uint8  | Prototype code (data type, MODULE_DATA only)   |
| 15+     | Variable | varies | Data payload (MODULE_DATA only)                |

### Actor Microcontroller (101_log.npz)

Manages actuator hardware modules that control physical outputs.

| Module Type | Instance | Module Name  | Event Codes                                           |
|-------------|----------|--------------|-------------------------------------------------------|
| 3           | 1        | BrakeModule  | 51 (kEngaged), 52 (kDisengaged)                       |
| 5           | 1        | ValveModule  | 51 (kOpen), 52 (kClosed), 54 (kToneOn), 55 (kToneOff) |
| 5           | 2        | GasPuffValve | 51 (kOpen), 52 (kClosed)                              |
| 7           | 1        | ScreenModule | 51 (kOn), 52 (kOff)                                   |

**Output Files:**

| Output File              | Columns                                              | Description                        |
|--------------------------|------------------------------------------------------|------------------------------------|
| `brake_data.feather`     | `time_us`, `brake_torque_N_cm`                       | Brake engagement torque            |
| `valve_data.feather`     | `time_us`, `dispensed_water_volume_uL`, `tone_state` | Water rewards and tone cues        |
| `gas_puff_data.feather`  | `time_us`, `puff_state`, `cumulative_puff_count`     | Gas puff delivery events           |
| `screen_data.feather`    | `time_us`, `screen_state`                            | VR screen on/off state             |

### Sensor Microcontroller (152_log.npz)

Manages sensor hardware modules that capture animal behavior.

| Module Type | Instance | Module Name   | Event Codes                                      |
|-------------|----------|---------------|--------------------------------------------------|
| 4           | 1        | LickModule    | 51 (kChanged) with 12-bit ADC voltage            |
| 6           | 1        | TorqueModule  | 51 (kCCWTorque), 52 (kCWTorque)                  |
| 1           | 1        | TTLModule     | 51 (kInputOn), 52 (kInputOff) for mesoscope sync |

**Output Files:**

| Output File                    | Columns                                       | Description                 |
|--------------------------------|-----------------------------------------------|-----------------------------|
| `lick_data.feather`            | `time_us`, `voltage_12_bit_adc`, `lick_state` | Lick sensor readings        |
| `torque_data.feather`          | `time_us`, `torque_N_cm`                      | Wheel torque measurements   |
| `mesoscope_frame_data.feather` | `time_us`, `ttl_state`                        | Mesoscope frame sync pulses |

### Encoder Microcontroller (203_log.npz)

Manages the rotary encoder for tracking animal locomotion.

| Module Type | Instance | Module Name    | Event Codes                                     |
|-------------|----------|----------------|-------------------------------------------------|
| 2           | 1        | EncoderModule  | 51 (kRotatedCCW), 52 (kRotatedCW) with float64  |

**Output Files:**

| Output File            | Columns                           | Description                  |
|------------------------|-----------------------------------|------------------------------|
| `encoder_data.feather` | `time_us`, `traveled_distance_cm` | Cumulative distance traveled |

---

## Hardware Configuration Dependencies

Processing depends on hardware calibration values stored in `hardware_state.yaml`:

| Parameter                     | Used By             | Description                              |
|-------------------------------|---------------------|------------------------------------------|
| `cm_per_pulse`                | Encoder processing  | Converts encoder pulses to distance (cm) |
| `lick_threshold`              | Lick processing     | ADC threshold for lick detection         |
| `torque_per_adc_unit`         | Torque processing   | Converts ADC to torque (N·cm)            |
| `valve_scale_coefficient`     | Valve processing    | Power law coefficient for water volume   |
| `valve_nonlinearity_exponent` | Valve processing    | Power law exponent for water volume      |
| `minimum_brake_strength`      | Brake processing    | Minimum brake torque (N·cm)              |
| `maximum_brake_strength`      | Brake processing    | Maximum brake torque (N·cm)              |
| `screens_initially_on`        | Screen processing   | Initial screen state at startup          |
| `recorded_mesoscope_ttl`      | TTL processing      | Whether mesoscope sync was recorded      |
| `delivered_gas_puffs`         | Gas puff processing | Whether gas puffs were delivered         |

Missing calibration values cause the corresponding module to be skipped during processing.

---

## Common Error Patterns

This section describes common errors encountered during processing and their root causes.

### Log File Errors

| Error Pattern                            | Likely Cause                                        | Resolution                                    |
|------------------------------------------|-----------------------------------------------------|-----------------------------------------------|
| `FileNotFoundError: *_log.npz`           | Log file missing from session                       | Check if hardware was enabled during session  |
| `KeyError: 'log_data'`                   | Corrupted or malformed NPZ archive                  | Re-acquire session data                       |
| `ValueError: buffer size`                | Truncated log file (incomplete write)               | Re-acquire session data                       |
| `IndexError: index out of bounds`        | Empty log file or no valid messages                 | Verify hardware was recording                 |

### Configuration Errors

| Error Pattern                            | Likely Cause                                        | Resolution                                    |
|------------------------------------------|-----------------------------------------------------|-----------------------------------------------|
| `KeyError: 'cm_per_pulse'`               | Missing encoder calibration in hardware_state.yaml  | Add calibration value to hardware_state.yaml  |
| `KeyError: 'lick_threshold'`             | Missing lick calibration                            | Add lick_threshold to hardware_state.yaml     |
| `FileNotFoundError: hardware_state.yaml` | Hardware state file missing                         | Ensure session has hardware_state.yaml        |
| `FileNotFoundError: session_data.yaml`   | Invalid session directory structure                 | Verify session path is correct                |

### Data Processing Errors

| Error Pattern                            | Likely Cause                                        | Resolution                                    |
|------------------------------------------|-----------------------------------------------------|-----------------------------------------------|
| `ValueError: trial motif not found`      | Cue sequence contains unknown trial pattern         | Check experiment_configuration.yaml motifs    |
| `ZeroDivisionError` in torque processing | torque_per_adc_unit is zero                         | Correct calibration value                     |
| `OverflowError` in timestamp conversion  | Timestamp overflow (corrupt data)                   | Re-acquire session data                       |

### Debugging Workflow

When errors occur:

1. **Identify the failing job** from the status output (e.g., `actor_microcontroller_processing: failed`)
2. **Map job to log file** using the source ID table above
3. **Check for common error patterns** in the error message
4. **Verify input files exist** in the session's `raw_data/` directory
5. **Check hardware_state.yaml** for required calibration values
